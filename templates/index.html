<!-- Script -->
<script>
  async function analyzeAll() {
    const html = document.getElementById("htmlInput").value;
    const url = document.getElementById("urlInput").value.trim();
    const tbody = document.querySelector("#resultsTable tbody");
    const loading = document.getElementById("loading");

    tbody.innerHTML = "";
    loading.style.display = "block";
    document.getElementById("resultsTable").style.display = "none";
    document.getElementById("exportButton").style.display = "none";

    const results = {};

    if (html.length > 0) {
      const htmlResponse = await fetch("/check-seo", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ html })
      });
      Object.assign(results, await htmlResponse.json());
    }

    if (url.length > 0) {
      const metaResponse = await fetch("/check-meta", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url })
      });
      Object.assign(results, await metaResponse.json());
    }

    const labelMapping = {
      "Title": "Meta Title",
      "Meta Description": "Meta Description",
      "Meta Robots": "Angaben für die Suchmaschine",
      "Canonical": "Canonical-Tag",
      "H1": "H1-Überschrift",
      "Bilder ALT-Attribute": "Alt-Attribute der Bilder auf der Seite",
      "robots.txt": "robots.txt",
      "Sitemap": "XML-Sitemap"
    };

    const greenKeywords = ["alles okay", "ok", "vorhanden", "ist indexiert, links werden gefolgt"];
    const redKeywords = ["nicht vorhanden", "zu kurz", "zu lang", "zu viele", "fehl", "fehlt"];

    for (const [key, value] of Object.entries(results)) {
      const status = value.Status.toLowerCase().trim();
      const isSuccess = greenKeywords.some(k => status.includes(k));
      const isError = redKeywords.some(k => status.includes(k));
      const rowClass = isSuccess ? "success" : (isError ? "error" : "");

      const displayKey = labelMapping[key] || key;

      const row = `<tr class="${rowClass}">
        <td>${displayKey}</td>
        <td>${value.Status}</td>
        <td>${value.Details.startsWith('http') ? `<a href='${value.Details}' target='_blank'>${value.Details}</a>` : value.Details}</td>
      </tr>`;
      tbody.innerHTML += row;
    }

    document.getElementById("resultsTable").style.display = "table";
    document.getElementById("exportButton").style.display = "block";
    loading.style.display = "none";
  }

  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(14);
    doc.text("SEO Analyse Ergebnisse", 10, 10);

    let y = 20;
    document.querySelectorAll("#resultsTable tbody tr").forEach(row => {
      const cells = row.querySelectorAll("td");
      const text = `${cells[0].innerText}: ${cells[1].innerText} – ${cells[2].innerText}`;
      doc.text(text, 10, y);
      y += 10;
    });

    doc.save("seo-analyse.pdf");
  }

  document.querySelector("footer").innerHTML = document.querySelector("footer").innerHTML.replace("{{ year }}", new Date().getFullYear());
</script>
